steps:
  # Step 1: Fetch the GitHub token from Secret Manager
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Fetch the GitHub token from Secret Manager
        GITHUB_TOKEN=$(gcloud secrets versions access latest --secret="github_token" --format="get(payload.data)" | tr '_-' '/+' | base64 -d)
        echo $GITHUB_TOKEN > github_token.txt

  # Step 2: Install the GitHub CLI
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update && apt-get install -y gh

  # Step 3: Create a GitHub release for the provided tag
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Source the GitHub token
        GITHUB_TOKEN=$(cat github_token.txt)

        # Authenticate with GitHub CLI
        echo $GITHUB_TOKEN | gh auth login --with-token

        # Use the provided tag name and other environment variables
        TAG_NAME=$TAG_NAME
        RELEASE_TITLE=$RELEASE_TITLE
        RELEASE_NOTES=$RELEASE_NOTES

        echo "Using tag: $TAG_NAME"
        echo "Release title: $RELEASE_TITLE"
        echo "Release notes: $RELEASE_NOTES"

        # Create a new GitHub release
        gh release create $TAG_NAME --title "$RELEASE_TITLE" --notes "$RELEASE_NOTES"

        echo "Release $TAG_NAME created successfully!"

substitutions:
  TAG_NAME: 'v1.0.0'
  RELEASE_TITLE: 'Initial Release'
  RELEASE_NOTES: 'Release notes for the initial release.'

secrets:
  - secretEnv:
      GITHUB_TOKEN: "github_token"
